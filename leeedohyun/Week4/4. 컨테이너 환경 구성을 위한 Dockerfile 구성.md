# 코드로 개발하는 컨테이너 인프라, Dockerfile
## IaC와 Dockerfile
Dockerfile이란, 원하는 개발 환경을 코드로 구성하는 방법을 제공하는 것을 말한다. Dockerfile을 이해하기 위해서 IaC가 필요한 이유에 대해서 알아야 한다.

- 커맨드 기반의 인프라 구성 시 사용자 실수 등의 인적 오류 가능성이 높다.
- APM(Apache + PHP + MySQL) 구축에서 설치 순서와 상호 연관성 등을 고려하여 각종 라이브러리와 함께 복잡한 명령어를 고민해야 한다.
- 각종 환경 설정 정보와 설치 프로그램을 요구 사항에 맞게 따져봐야 한다.
- 만일 설치 이후에 잘못된 설정이 있다면 수정해야 하고, 때로는 재설치도 불가피하다.

## 최적의 Dockerfile 만들기
- 경량의 컨테이너 서비스를 제공
- Dockerfile에 담기는 레이어를 최소화
- 도커의 철학! 하나의 애플리케이션은 하나의 컨테이너에
- 캐시 기능을 활용
- IaC 환경 개발은 디렉터리 단위로
- 서버리스 환경으로 개발

# Docker file 명령어와 이미지 빌드

<img src="https://github.com/leeedohyun/Docker-WIL/assets/116694226/2ba6ea41-8031-41a0-abe8-0a63087ca073" width=500>

## Dockerfile 명령어
Dockerfile은 필요로 하는 개발환경을 제공하기 위한 여러 가지 명령어들의 집합체이다. 

|명령어| 설명
|------|------
FROM| 생성하려는 이미지의 베이스 이미지 지정
MAINTAINER| 일반적으로 이미지를 빌드한 작성자 이름과 이메일을 작성
LABEL| 이미지 작성 목적으로 버전, 타이틀, 설명, 라이센스 정보 등을 작성
RUN| 설정된 기본 이미지에 패키지 업데이트, 각종 패키지 설치, 명령 실행 등을 작성
CMD| 생성된 이미지를 컨테이너로 실행할 때 실행되는 명령, ENTRYPOINT 명령문으로 지정된 커맨드에 디폴트로 넘길 파라미터를 지정할 때 사용
ENTRYPOINT| 컨테이너가 실행될 때 명령어 및 인자 값을 전달하여 실행
COPY| 호스트 환경의 파일, 디렉터리를 이미지 안에 복사하는 경우 작성
ADD| 호스트 환경의 파일, 디렉터리를 이미지 안에 복사하는 경우뿐만 아니라 URL 주소에서 직접 다운로드하여 이미지에 넣을 수도 있고, 압축 파일인 경우에는 지정한 경로에 압축을 풀어서 추가
ENV| 이미지 안에 각종 환경 변수를 지정
EXPOSE| 컨테이너가 호스트 네트워크를 통해 들어오는 트래픽을 리스닝하는 포트와 프로토콜을 지정
VOLUME| 볼륨을 이미지 빌드에 미리 설정하는 경우 작성
USER| 애플리케이션이 권한 없이 서비스를 실행할 수 있다면 USER를 통해 다른 사용자로 변경하여 사용
WORKDIR| 컨테이너상에서 작업할 경로 전환
ARG| docker build 시점에서 변숫값을 전달
ONBUILD| 처음 이미지 빌드에 포함하지만 실행되지 않고, 해당 이미지가 다른 이미지의 기본 이미지로 사용되는 경우 실행될 명령 지정
STOPSIGNAL| docker stop 명령을 사용할 때 다른 시그널을 넣을 때 사용
HEALTHCHECK| 컨테이너의 프로세스 상태를 체크
SHELL| Dockerfile 내부에서 사용할 기본 셸을 지정

## 이미지 생성을 위한 Dockerfile 빌드
### 이미지 빌드
```linux
docker build [옵션] 이미지명:[태그] 경로 | URL | 압축 파일
```

### 왜 Dockerfile이 필요한가?
인프라 구성 정보를 코드로 관리해두면 애플리케이션 개발 시 버전 관리 차원의 소스코드 관리가 가능해져 변경 이력을 관리할 수 있다. 이러한 소스코드를 통해 전체 구성을 한눈에 파악할 수 있고 사용자 의존성을 배제할 수 있다.

## 이미지 빌드 과정
### Dockerfile 작성 라이프사이클
docker build를 실행하는 현재 작업 중인 디렉터리를 빌드 컨텍스트라고 부른다. Dockerfile은 새로운 빈 디렉터리에 생성하여 빌드하는 것을 권장한다. 이미지 빌드가 시작되면 Dockerfile 위치와 상관없이 현재 디렉터리에 있는 모든 파일과 디렉터리의 컨텐츠는 도커 데몬에 빌드 컨텍스트로 전달된다. 

# Dockerfile을 활용한 다양한 이미지 생성
FROM 명령에는 용량이 작은 리눅스를 선택하면 빌드 속도가 빨리질 것이다. COPY에 사용된 소스코드 복사는 RUN 명령어를 사용한 패키지 종속성 설치 이후에 작성한다.